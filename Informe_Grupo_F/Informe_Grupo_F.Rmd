---
title: Análisis de la relación entre la actividad turística y el empleo en el sector servicios en España
author:
  - name: "Iyán Álvarez, Azahara Martínez, Juan Alcaraz"
  - afiliation: 'Universitat de València'
date: "`r Sys.Date()`"
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
  pdf_document:
    latex_engine: xelatex
  html_document: default
abstract: |
  El presente informe analiza la evolución del turismo en España y su relación con la ocupación en el sector servicios, a partir de datos oficiales del INE. Se integraron dos bases de datos —una sobre viajeros y pernoctaciones, y otra sobre empleo por sectores— para realizar un análisis exploratorio, univariante y bivariante a nivel de comunidad autónoma. 
  Los resultados muestran una clara tendencia creciente y estacional en la actividad turística, así como una relación positiva y estadísticamente significativa entre el turismo y el empleo en la mayoría de las comunidades autónomas. Sin embargo, las elasticidades obtenidas son bajas, lo que indica que, aunque ambas variables evolucionan conjuntamente, el empleo responde de forma inelástica a las variaciones del turismo. 
  En conjunto, los resultados sugieren que el turismo constituye un motor relevante del empleo en los servicios, aunque su efecto es moderado y depende de la estructura económica de cada territorio.
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
```

```{r Librerias, include=FALSE}
library(lubridate)
library(tidyr)
library(tidyverse)
library(scales)
library(stringr)
library(zoo)
library(purrr)
library(forecast)
library(leaflet)
library(sf)
library(dplyr)
library(ggplot2)
library(giscoR)
library(pacman)
```

# INTRODUCCIÓN

## CONTEXTO GENERAL

El turismo constituye uno de los principales motores económicos de España, aportando una parte significativa al Producto Interior Bruto y al empleo nacional. La actividad turística no solo influye en la generación de riqueza, sino también en el dinamismo de otros sectores, como el transporte, la hostelería o el comercio.

En los últimos años, la evolución del turismo español ha experimentado variaciones notables, especialmente durante el periodo marcado por la pandemia de la COVID-19, que provocó una caída sin precedentes en los flujos de viajeros y en los niveles de ocupación del sector servicios. A partir de 2021, el proceso de recuperación ha sido desigual entre las comunidades autónomas, lo que hace necesario un análisis detallado que permita comprender las tendencias y relaciones entre las distintas variables implicadas.

En este contexto, el presente trabajo realiza un análisis exploratorio a partir de datos oficiales del **Instituto Nacional de Estadística (INE)**, con el objetivo de examinar la evolución del turismo y su relación con la ocupación en el sector servicios. Este enfoque permite no solo identificar patrones y correlaciones, sino también detectar posibles valores atípicos derivados de eventos excepcionales, como la crisis sanitaria, que pueden distorsionar la interpretación de los resultados.

## DESCRIPCIÓN DE LOS DATOS

Para el desarrollo del presente análisis se han empleado dos bases de datos principales.

La primera recoge información sobre el turismo en España, desglosada por comunidades autónomas y provincias, e incluye variables como el número de viajeros y las pernoctaciones registradas a lo largo de varios años.

La segunda base de datos corresponde al sector servicios, concretamente a la ocupación laboral dentro del mismo, y se analiza con el propósito de explorar su relación con la evolución del turismo.

## CUESTIONES A TRATAR

En este estudio se abordan **tres** cuestiones principales:

1. ¿Cómo tratar los valores atípicos (outliers) asociados al periodo de la pandemia de la COVID-19 (2019-2021)?

2. ¿Qué evolución ha experimentado el turismo en las distintas comunidades autónomas a lo largo del periodo analizado?

3. ¿Qué relación existe entre la evolución del turismo y la ocupación en el sector servicios?

# IMPORTACIÓN

Para garantizar el uso de datos actualizados, la importación se realiza directamente desde las URLs oficiales del INE, evitando copias locales.

```{r Enlaces de descarga, include=FALSE}
url_ocupacion<-"https://www.ine.es/jaxiT3/files/t/es/csv_bdsc/65311.csv?nocab=1"
url_turismo<-"https://www.ine.es/jaxiT3/files/t/es/csv_bdsc/67190.csv?nocab=1"
```

Antes de la carga definitiva, se comprobó la codificación de los archivos para evitar errores de lectura, optando por el formato **UTF-8**.

```{r Codificación de los archivos, include=FALSE}
guess_encoding(url_turismo)
guess_encoding(url_ocupacion)
```

Finalmente, los datos se importaron y almacenaron en dos data frames principales: uno para turismo y otro para ocupación.

```{r Importación, include=FALSE}
df_Turismo <- read.csv(url_turismo,
                       header = TRUE,
                       sep = ";",
                       encoding = "UTF-8")

df_Ocupacion <- read.csv(url_ocupacion,
                       header = TRUE,
                       sep = ";",
                       dec = ",",
                       encoding = "UTF-8")
```

# ANÁLISIS UNIVARIANTE

Antes de realizar el análisis univariante, es necesario limpiar y preparar las bases de datos. A continuación, se procede al tratamiento individual de cada una: primero la base de turismo y posteriormente la base de ocupación.

## TURISMO

### Limpieza

Una vez importados los datos, se analizan las características generales del conjunto correspondiente al turismo en España. Este dataset recoge el número de viajeros y pernoctaciones por comunidad y provincia a lo largo del tiempo.

```{r Cálculo dimension, include=FALSE}
dim(df_Turismo)
```
En un inicio, este dataset se forma de 134.820 filas y 8 columnas, cuyo nombre resulta completamente representativo.

Las variables incluidas son:

- **Totales.Territoriales**: columna con un único valor (“Total Nacional”).

- **Comunidades.y.Ciudades.Autónomas**: variable categórica que representa las comunidades o ciudades autónomas de España.

- **Provincias**: variable categórica que muestra la provincia asociada.

- **Viajeros.y.pernoctaciones**: variable categórica. Indica el tipo de registro (viajeros o pernoctaciones).

- **Residencia..Nivel.1**: variable categórica redundante que contiene el valor “Total” en todas sus observaciones. 

- **Residencia..Nivel.2**: variable categórica que indica el origen de los viajeros, diferenciando entre residentes en España y residentes en el extranjero.

- **Periodo**: variable tipo fecha que representa el año y mes de la observación.

- **Total**: valor numérico de viajeros o pernoctaciones expresado en millones.

Las variables Totales.Territoriales, Viajeros.y.pernoctaciones, Residencia..Nivel.1 y Residencia..Nivel.2, no aportan información relevante y se eliminan en fases posteriores.

A continuación, se utilizó la función `glimpse()` del paquete `dplyr` para obtener una vista general del dataset, comprobando que todas las columnas se importaron como tipo carácter y que será necesario ajustar sus tipos en etapas posteriores.

```{r, include=FALSE}
df_Turismo %>% glimpse()
```
Gracias a esto, se observa que todas las columnas se importaron inicialmente como tipo character. Por ello, en la fase de preparación se realizará la conversión a tipos de datos adecuados (fechas, factores y numéricos) para facilitar el análisis estadístico y gráfico.

Para asegurar la correcta manipulación numérica, se eliminaron los puntos utilizados como separadores de miles en la columna Total.

```{r}
df_Turismo <- df_Turismo %>% 
  mutate(Total = str_replace_all(Total, "\\.", ""))
```

Posteriormente, se aplicó `sapply()` junto con `unique()` para revisar los valores de cada variable y detectar posibles inconsistencias.

```{r, echo=FALSE}
sapply(df_Turismo, function(x) length(unique(x)))
```

Se identificaron varias **incidencias**: la columna Totales.Territoriales presentaba un único valor (“Total nacional”), y Comunidades.y.Ciudades.Autónomas incluía 20 categorías en lugar de 19, debido a registros vacíos o duplicados.

```{r, echo=FALSE}
print(unique(df_Turismo$Comunidades.y.Ciudades.Autónomas))
```
Además, se observó que la variable CCAA presentaba registros vacíos o en blanco, lo que explica las discrepancias detectadas anteriormente. Estos valores se eliminarán en la fase de limpieza del dataset.

El siguiente paso fue eliminar las filas y columnas redundantes, así como los valores en blanco, manteniendo únicamente la información agregada por comunidades autónomas. 

```{r}
df_Turismo <- df_Turismo %>%
  select(-Totales.Territoriales) %>%
  filter(str_trim(Comunidades.y.Ciudades.Autónomas) != "") %>% 
  arrange(Comunidades.y.Ciudades.Autónomas, Provincias, Periodo)
```

Posteriormente, con el fin de facilitar la interpretación y el análisis comparativo, se optó por trabajar con los datos agregados a nivel de comunidades y ciudades autónomas. Este enfoque proporciona una visión más general del comportamiento del turismo en España, adecuada para su posterior comparación con la ocupación en el sector servicios.

En consecuencia, se eliminaron las variables no relevantes para este nivel de análisis (Provincias, Viajeros.y.pernoctaciones, Residencia..Nivel.1 y Residencia..Nivel.2).

```{r, echo=FALSE}
df_Turismo <- df_Turismo %>%
  select(-c(Provincias,Viajeros.y.pernoctaciones,
            Residencia..Nivel.1,
            Residencia..Nivel.2))
```

Dado que todas las variables se importaron inicialmente como texto, fue necesario convertir Periodo al formato de fecha. Para ello, se sustituyó el carácter “M” por un guion y se aplicó la función `ym()` para reconocer correctamente el año y el mes.

```{r, echo=FALSE}
df_Turismo <- df_Turismo %>%
  mutate(Periodo = str_replace(Periodo, "M", "-"), 
    Periodo = ym(Periodo))
```

Además, la variable Total se convirtió a tipo numérico para permitir la realización de cálculos y análisis estadísticos sin errores de formato.

```{r, echo=FALSE}
df_Turismo <- df_Turismo %>% 
  mutate(Total=as.numeric(Total))
```

Antes de convertir la variable Comunidades.y.Ciudades.Autónomas a tipo factor, se limpiaron y estandarizaron sus valores eliminando números, espacios y caracteres innecesarios.

Finalmente, se renombró como CCAA y se definió como variable categórica tipo factor.

```{r}
df_Turismo <- df_Turismo %>% 
  rename(CCAA = Comunidades.y.Ciudades.Autónomas) %>% 
  mutate(
    CCAA = str_replace(CCAA, "^[0-9]+\\s+", ""),
    CCAA = str_replace(CCAA,
                       "^\\s*([^,]+?)\\s*,\\s*([^,]+?)\\s*$", "\\2 \\1"),
    CCAA = str_squish(CCAA)
  ) %>%
  mutate(CCAA = as.factor(CCAA))
```

Para continuar con el análisis, se creó un nuevo conjunto de datos agregado a nivel de comunidad autónoma.

```{r}
df_Turismo <- df_Turismo %>%
  group_by(CCAA, Periodo) %>% 
  summarise(Total = sum(Total, na.rm = TRUE), .groups = "drop")
```

Tras la limpieza, se comprobó la ausencia de espacios en blanco y valores faltantes (NA) para asegurar la integridad del conjunto de datos. Al no detectarse incidencias, el dataset quedó listo para el análisis y se guardó en formato RData.

```{r, include=FALSE}
#Huecos en blanco
sum(df_Turismo == "", na.rm = TRUE)
colSums(df_Turismo == "", na.rm = TRUE)

#NA
anyNA(df_Turismo)
colSums(is.na(df_Turismo))
```

### Análisis

Como primer paso del análisis univariante, se calcularon los estadísticos descriptivos básicos con el fin de obtener una visión general de las variables del conjunto de datos.

```{r, echo=FALSE}
summary(df_Turismo)
```
El resumen estadístico muestra que todas las comunidades autónomas tienen el mismo número de observaciones, con registros trimestrales entre 1999 y 2025. La variable Total presenta un mínimo de 0 (probablemente asociado a la pandemia), una media de 6,27 millones y un máximo de 54 millones, reflejando una notable variabilidad entre regiones y periodos.

Dado que la función `summary()` ofrece información limitada para variables categóricas, se amplió el análisis calculando los principales estadísticos descriptivos de Total por comunidad autónoma. Este enfoque permite comparar la magnitud y variabilidad del turismo entre regiones, antes de profundizar en las relaciones en el análisis bivariante.

```{r, echo=FALSE}
df_Turismo %>%
  group_by(CCAA) %>%
  summarise(
    media = mean(Total, na.rm = TRUE),
    mediana = median(Total, na.rm = TRUE),
    sd = sd(Total, na.rm = TRUE),
    min = min(Total, na.rm = TRUE),
    max = max(Total, na.rm = TRUE),
    IQR=IQR(Total, na.rm=TRUE),
  ) %>%
  arrange(desc(media)) %>% 
  print()
```

Los resultados muestran que Cataluña presenta la media más alta en el número de turistas, lo que refleja su consolidación como uno de los principales destinos turísticos del país. Le siguen Baleares, Canarias y Andalucía, todas ellas comunidades con una fuerte especialización en el sector turístico.

En el extremo opuesto, Melilla, Ceuta, La Rioja y Navarra registran las medias más bajas, lo que podría deberse a su menor capacidad de atracción turística o a un peso económico menos centrado en este sector.

Para obtener una visión general del comportamiento del turismo en el conjunto del país, se calcularon los principales estadísticos descriptivos del Total Nacional, agregando los valores de todas las comunidades por periodo.

```{r, include=FALSE}
nacional_mensual <- df_Turismo %>%
  group_by(Periodo) %>%
  summarise(Total = sum(Total, na.rm = TRUE), .groups = "drop")

nacional_mensual %>%
  summarise(
    media = mean(Total, na.rm = TRUE),
    mediana = median(Total, na.rm = TRUE),
    sd = sd(Total, na.rm = TRUE),
    var = var(Total, na.rm = TRUE),
    min = min(Total, na.rm = TRUE),
    max = max(Total, na.rm = TRUE),
    N = n()
  )
```

Además, se han analizado los resultados agregados a nivel nacional y muestran una media de aproximadamente 119 millones de turistas por periodo y una mediana cercana a 112 millones, lo que indica una distribución relativamente equilibrada aunque con cierta asimetría hacia los valores altos.

La desviación típica, de unos 52 millones, junto con una varianza elevada, refleja una alta variabilidad en el volumen de turismo entre periodos.

El valor mínimo (0) corresponde al impacto de la pandemia de la COVID-19, mientras que el máximo (247,9 millones) evidencia los picos alcanzados en los años de mayor actividad turística.

-------

Para ilustrar la evolución del turismo en el conjunto nacional, se elaboró una serie temporal que permite observar las principales tendencias y patrones estacionales.

```{r Gráfico 1, echo=FALSE, out.height="20%", out.width="70%"}
ggplot(nacional_mensual, aes(Periodo, Total)) +
  geom_line(linewidth = 0.8) +
  scale_y_continuous(labels = label_comma(big.mark = ".", decimal.mark = ","))+
  labs(title = "Serie temporal de viajeros por mes",
       x = "Periodo", y = "Total") +
  theme_minimal()
```

La gráfica muestra una tendencia general al alza con una clara estacionalidad anual, marcada por picos recurrentes en los meses de mayor actividad turística. También se identifican valores atípicos durante el periodo de la pandemia de la COVID-19, que reflejan la brusca caída del sector en esos años.

A continuación, se representa la serie temporal de cada comunidad y ciudad autónoma para analizar la evolución del turismo y comparar sus comportamientos a lo largo del tiempo.

```{r Gráfico 2, echo=FALSE ,out.height="30%", out.width="70%"}
ca_mensual <- df_Turismo %>%
  group_by(CCAA, Periodo) %>%
  summarise(Total = sum(Total, na.rm = TRUE), .groups = "drop")

ggplot(ca_mensual, aes(Periodo, Total)) +
  geom_line(linewidth = 0.6) +
  facet_wrap(~ CCAA, scales = "free_y", ncol = 3) +
  scale_y_continuous(labels = label_comma(big.mark = ".", decimal.mark = ","))+
  labs(title = "Serie temporal por Comunidad Autónoma",
       x = "Periodo", y = "Total") +
  theme_minimal()
```

En general, todas las comunidades muestran una marcada estacionalidad, con picos de actividad durante los meses de verano. A largo plazo, Madrid, el País Vasco y Canarias presentan una tendencia claramente creciente, mientras que otras, como Ceuta, mantienen una evolución más estable.

Asimismo, se observa heterocedasticidad en regiones como Illes Balears, Asturias, Andalucía o la Comunitat Valenciana, donde la variabilidad aumenta con el número de turistas, a diferencia de Madrid o Canarias, donde la dispersión se mantiene más constante.

Por último, todas las comunidades registran una caída abrupta en 2020, asociada al impacto de la pandemia de la COVID-19.
En el siguiente apartado se aplicará el método 3sigma estacional (por mes y comunidad autónoma) para identificar de forma formal los valores atípicos sin confundirlos con la estacionalidad natural de la serie.

### Detección de outliers

Para la detección de valores atípicos en las series de turismo se aplicaron tres métodos estadísticos complementarios:

- **Regla 3-sigmas**: considera como *outliers* los valores que se alejan más de tres desviaciones típicas respecto a la media.  
- **Método de Hampel**: utiliza la mediana y la desviación absoluta mediana (MAD) para detectar observaciones atípicas, siendo más robusto frente a valores extremos.  
- **Método del Boxplot**: identifica *outliers* a partir de los límites del rango intercuartílico (1,5×IQR).  

En todos los casos se aplicó una versión estacional del método, calculando los parámetros (media, desviación, mediana o cuartiles) por mes y comunidad autónoma, con el objetivo de evitar clasificar como atípicos los picos o caídas debidos a la estacionalidad turística.  

Los gráficos se generaron automáticamente para cada comunidad autónoma, aunque solo se muestra un ejemplo en el informe. Todos ellos se han guardado en carpetas independientes:  
`graficos_outliers_3sigma`, `graficos_outliers_hampel` y `graficos_outliers_boxplot`.

```{r Regla 3 Sigma, include=FALSE}
Sigma3_est <- function(x, k = 3) {
  media <- mean(x, na.rm = TRUE)
  desv <- sd(x, na.rm = TRUE)
  out <- abs(x - media) > (k * desv)
}
```

```{r, echo=FALSE}
outliers_sigma3_est <- df_Turismo %>%
  mutate(Mes = month(as.Date(Periodo), label = TRUE, abbr = TRUE)) %>% 
  group_by(CCAA, Mes) %>%
  mutate(
    es_outlier_sigma3 = Sigma3_est(Total)
  ) %>%
  ungroup()
```

```{r Gráfico 3, echo=FALSE, out.height="30%", out.width="70%"}
if(!dir.exists("graficos_outliers_3sigma")){
  dir.create("graficos_outliers_3sigma")
}

ccaa_lista <- unique(outliers_sigma3_est$CCAA)

for (cc in ccaa_lista) {
  p <- outliers_sigma3_est %>%
    filter(CCAA == cc) %>%
    ggplot(aes(Periodo, Total)) +
    geom_line(color = "grey70") +
    geom_point(aes(color = es_outlier_sigma3)) +
    scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
    labs(
      title = paste("Detección estacional de outliers (3-sigma)-", cc),
      x = "Periodo", 
      y = "Total", 
      color = "Outlier"
    ) +
    theme_minimal()
  
  ggsave(
    filename = paste0("graficos_outliers_3sigma/outliers_", gsub(" ", "_", cc), ".png"),
    plot = p, width = 8, height = 5
  )
}

#Ejemplo
outliers_sigma3_est %>%
  filter(CCAA == "Andalucía") %>%
  ggplot(aes(Periodo, Total)) +
  geom_line(color = "grey70") +
  geom_point(aes(color = es_outlier_sigma3)) +
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
  labs(
    title = "Detección estacional de outliers (3-sigma) - Andalucía",
    x = "Periodo", 
    y = "Total", 
    color = "Outlier"
  ) +
  theme_minimal()
```

```{r, include=FALSE}
df_Turismo %>%
  mutate(Mes = month(as.Date(Periodo), label = TRUE, abbr = TRUE)) %>% 
  group_by(CCAA, Mes) %>%
  filter(Mes=='jul') %>% 
  summarise(
    media = mean(Total, na.rm = TRUE),
    varianza = var(Total, na.rm = TRUE),
    mediana = median(Total, na.rm = TRUE),
    desviacion_tipica = sd(Total, na.rm = TRUE),
    minimo = min(Total, na.rm = TRUE),
    maximo = max(Total, na.rm = TRUE),
    n_observaciones = n()
  ) %>% 
  arrange(desc(desviacion_tipica))
```


```{r Regla Hampel, include=FALSE}
Hampel_est <- function(x, k = 3) {
  abs(x - median(x)) > k * mad(x)
}
```

```{r, echo=FALSE}
outliers_hampel_est <- df_Turismo %>%
  mutate(Mes = month(as.Date(Periodo), label = TRUE, abbr = TRUE)) %>%
  group_by(CCAA, Mes) %>% 
  mutate(
    es_outlier_hampel = Hampel_est(Total)
  ) %>%
  ungroup()
```


```{r Gráfico 4, echo=FALSE, out.height="30%", out.width="70%"}
if(!dir.exists("graficos_outliers_hampel")){
  dir.create("graficos_outliers_hampel")
}

ccaa_lista <- unique(outliers_hampel_est$CCAA)

for (cc in ccaa_lista) {
  p <- outliers_hampel_est %>%
    filter(CCAA == cc) %>%
    ggplot(aes(Periodo, Total)) +
    geom_line(color = "grey70") +
    geom_point(aes(color = es_outlier_hampel)) +
    scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
    labs(
      title = paste("Detección estacional de outliers (Hampel) -", cc),
      x = "Periodo", 
      y = "Total", 
      color = "Outlier"
    ) +
    theme_minimal()
  
  ggsave(
    filename = paste0("graficos_outliers_hampel/outliers_Hampel_", gsub(" ", "_", cc), ".png"),
    plot = p, width = 8, height = 5
  )
}

#Ejemplo
outliers_hampel_est %>%
  filter(CCAA == "Andalucía") %>%
  ggplot(aes(Periodo, Total)) +
  geom_line(color = "grey70") +
  geom_point(aes(color = es_outlier_hampel)) +
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
  labs(
    title = "Detección estacional de outliers (Hampel) - Andalucía",
    x = "Periodo", 
    y = "Total", 
    color = "Outlier"
  ) +
  theme_minimal()

```


```{r Regla boxplot, include=FALSE}
Boxplot_est <- function(x, k = 1.5) {
  Q1 <- quantile(x, 0.25, na.rm = TRUE)
  Q3 <- quantile(x, 0.75, na.rm = TRUE)
  IQR_value <- Q3 - Q1
  inf <- Q1 - k * IQR_value
  sup <- Q3 + k * IQR_value
  (x < inf) | (x > sup)
}
```

```{r, echo=FALSE}
outliers_boxplot_est <- df_Turismo %>%
  mutate(Mes = month(as.Date(Periodo), label = TRUE, abbr = TRUE)) %>%
  group_by(CCAA, Mes) %>%
  mutate(
    es_outlier_boxplot = Boxplot_est(Total)
  ) %>%
  ungroup()
```

```{r Gráfico 5, echo=FALSE, out.height="30%", out.width="70%"}
if(!dir.exists("graficos_outliers_boxplot")){
  dir.create("graficos_outliers_boxplot")
}

ccaa_lista <- unique(outliers_boxplot_est$CCAA)

for (cc in ccaa_lista) {
  p <- outliers_boxplot_est %>%
    filter(CCAA == cc) %>%
    ggplot(aes(Periodo, Total)) +
    geom_line(color = "grey70") +
    geom_point(aes(color = es_outlier_boxplot)) +
    scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
    labs(
      title = paste("Detección de outliers (Boxplot) -", cc),
      x = "Periodo", 
      y = "Total", 
      color = "Outlier"
    ) +
    theme_minimal()
  
  ggsave(
    filename = paste0("graficos_outliers_boxplot/outliers_Boxplot_", gsub(" ", "_", cc), ".png"),
    plot = p, width = 8, height = 5
  )
}

#Ejemplo
outliers_boxplot_est %>%
  filter(CCAA == "Andalucía") %>%
  ggplot(aes(Periodo, Total)) +
  geom_line(color = "grey70") +
  geom_point(aes(color = es_outlier_boxplot)) +
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
  labs(
    title = "Detección de outliers (Boxplot) - Andalucía",
    x = "Periodo", 
    y = "Total", 
    color = "Outlier"
  ) +
  theme_minimal()
```

```{r, echo=FALSE}
df_outliers <- df_Turismo %>%
  mutate(Mes = month(as.Date(Periodo), label = TRUE, abbr = TRUE)) %>% 
  group_by(CCAA, Mes) %>%
  mutate(
    out_hampel  = Hampel_est(Total),
    out_boxplot = Boxplot_est(Total),
    out_sigma3  = Sigma3_est(Total)
  ) %>%
  ungroup()
```


```{r, echo=FALSE}
tabla_outliers_ccaa <- df_outliers %>%
  group_by(CCAA) %>%
  summarise(
    n_hampel  = sum(out_hampel,  na.rm = TRUE),
    n_boxplot = sum(out_boxplot, na.rm = TRUE),
    n_sigma3  = sum(out_sigma3,  na.rm = TRUE)
  ) %>%
  arrange(desc(n_hampel))

tabla_outliers_ccaa
```

Durante la aplicación de los distintos métodos de detección de valores atípicos (3-sigma, Hampel y Boxplot) se observó que algunas comunidades autónomas no presentaban *outliers*, lo cual resultaba poco coherente con la evolución visible de sus series temporales.

Para contrastar esta situación, se analizaron los estadísticos descriptivos de los valores mensuales (media, varianza y desviación típica). Este análisis permitió comprobar que, en algunos casos, como el de la Comunidad de Madrid, la desviación típica estacional es elevada debido a un crecimiento sostenido en los últimos años.  

Esto implica que, aunque la variabilidad dentro de cada año es baja, la variabilidad entre estaciones es alta, provocando que el método 3-sigma no identifique correctamente ciertos valores que visualmente podrían considerarse atípicos.

Este comportamiento también se repite en otras comunidades de similares características, donde las medias y la dispersión entre estaciones son altas.  

Dado que los resultados sugieren que los métodos tradicionales no captan adecuadamente todas las anomalías, y teniendo en cuenta el conocimiento contextual del fenómeno turístico, se ha decidido considerar como valores atípicos comunes el periodo comprendido entre marzo de 2020 y febrero de 2021, correspondiente al impacto más severo de la pandemia de la COVID-19.  

Este enfoque permite homogeneizar el tratamiento de outliers en todas las comunidades, evitando que diferencias en la dispersión estacional alteren la comparación entre regiones.


### Series de tiempo

Los datos de turismo referentes al periodo de la pandemia son claramente _outlier_, la pregunta principal es qué hacer con ellos. Esta pregunta no es sencilla, como se ha mencionado, hay métodos de detección que no los clasifican como tales.

La idea para justificar qué debemos hacer con estos datos anómalos es la siguiente, en general, si representamos la serie temporal de una comunidad autónoma se puede ver que la gran bajada del número de pernoctaciones a partir del mes de marzo de 2020, lo cual está directamente relacionado con el inicio del estado de alarma y la cuarentena nacional. 

Tras esto se mantienen unas cifras muy bajas hasta aproximadamente dos años después (dependiendo de la comunidad), coincidiendo con la declaración del final de la pandemia por parte de la OMS, los datos de estancias vuelven prácticamente a los niveles prepandemia, lo cual sugiere que este sector se recuperó de forma bastante rápida cuando la situación sanitaria lo permitió.

Esto hace pensar que la pandemia simplemente puso una "pausa" al turismo y tras ello la actividad en este sector continuó desarrollándose de la misma forma que lo venía haciendo en los últimos años, aunque si es cierto que el crecimiento se desaceleró ligeramente. Lo cual sugiere que los datos de la pandemia no aportan ningún tipo de información relevante.

Para darle respaldo a esta hipótesis nos proponemos hacer un análisis de la serie de datos de cada CCAA, cosa que es muy natural por la forma en la que están organizados los datos.

Entonces, se tomarán los datos previos a la pandemia y se utilizarán para crear un modelo $ARIMA(p, d, q)(P, D, Q)$, el ajuste de los parámetros se hace de forma automática con las función `auto.arima`. Tras el ajuste se usa la función `forecast` que permite utilizar el modelo para predecir una serie de valores en el futuro, en este caso de predicen los $12$ meses siguientes. 

```{r Función principal para el cálculo de la serie, include=FALSE}
# Dado que hay que hacer el mismo análisis de series de tiempo para cada comunidad y ciudad autónoma la mejor opción es hacer una función que automatice el proceso.

# Serie: es la serie que se usará para entrenar el modelo
# Serie_test: es la serie queremos predecir
# H: es el número de periodos en el futuro que se va a predecir, debe pasar que Serie_test, tenga longitud H

Prediccion <- function(Serie, Serie_test, H){
  Modelo <- auto.arima(Serie, stepwise=FALSE, approximation=FALSE)
  
  pred <- forecast(Modelo, h=H)
  
  # Un dataframe con la predicción
  df_forecast <- data.frame(
    tiempo = as.numeric(time(Serie_test)),
    valor = as.numeric(pred$mean),
    tipo = "Prediccion")
  
  # Un dataframe con los datos originales del periodo que vamos a predecir
  df_serie1 <- data.frame(
    tiempo = as.numeric(time(Serie_test)),
    valor = as.numeric(Serie_test),
    tipo = "Serie")
  
  # Un dataframe con la serie que se ha usado para entrenar
  df_serie2 <- data.frame(
    tiempo = as.numeric(time(Serie)),
    valor = as.numeric(Serie),
    tipo = "Serie")
  
  # dataframe con los datos ajustados por el modelo
  df_ajuste <- data.frame(
    tiempo = as.numeric(time(Serie)),
    valor = as.numeric(Serie - residuals(Modelo)),
    tipo = "Ajuste")
  
  df1 <- bind_rows(df_serie2, df_ajuste)
  df2 <- bind_rows(df_serie1, df_forecast)
  
  grafica_Ajuste <- ggplot(df1, aes(x = tiempo, y = valor, color = tipo)) + 
    geom_line(size = 1) +
    labs(title = "Gráfica de ajuste")
  
  grafica_Prediccion <- ggplot(df2, aes(x = tiempo, y = valor, color = tipo)) + 
    geom_line(size = 1) +
    labs(title = "Gráfica de predicción")
  
  Serie_aux <- ts(as.numeric(pred$mean), 
                  start=start(Serie_test), 
                  end=end(Serie_test),
                  frequency=frequency(Serie_test))
  
  return(list(Prediccion = pred, 
              Grafica_Ajuste = grafica_Ajuste, 
              Grafica_Predic = grafica_Prediccion,
              errores_predic = Errores(Serie_test, Serie_aux),
              errores_ajuste = Errores(Serie, Serie - residuals(Modelo)) ))
}
```

```{r Creación y análisis de las series, include=FALSE}

# Las siguientes líneas son las usadas para extraer la información del dataframe

Convertir_en_Serie <- function(vector, Anio_Inicio, Mes_Inicio, Anio_Final, Mes_Final, frec){
  return(ts(vector, start = c(Anio_Inicio, Mes_Inicio), end = c(Anio_Final, Mes_Final), frequency = frec))
}

Creacion <- function(comunidad){
  return(Convertir_en_Serie(df_Turismo[df_Turismo$CCAA == comunidad,]$Total, 1999, 1, 2025, 9, 12))
}
Series <- lapply(levels(df_Turismo$CCAA), Creacion)
names(Series) <- levels(df_Turismo$CCAA)

PrePandemia <- lapply(Series, function(x) window(x, start=start(x),end=c(2020, 2)))
Recorte <- function(serie, fechaIni=c(2022,3), fechaFin=c(2023, 2)){
  serie_nueva <- ts(serie, start=fechaIni, end=fechaFin, frequency = 12)
}
 
PostPandemia <- lapply(Series, Recorte)

```

```{r Análisis, include=FALSE}
# -------------------------### IMPORTANTE ###-----------------------------
# El proceso de ajustar el modelo arima para cada comunidad lleva un tiempo de computación elevado, por eso la línea siguiente está comentada, para ejecutar solo hay que descomentarla
# AnalisisBox <- mapply(Prediccion, PrePandemia, PostPandemia, rep(12,10))
```

Los resultados para cada comunidad se guardaron en un archivo llamado `AnalisisBox.rsd`. Se trata de una lista, si queremos acceder a ellos se pueden importar con el comando `readRSD("AnálisisBox.rsd")` y asignándolo a una variable.

```{r Importación de los resultados, include=FALSE}
AnalisisBox <- readRDS("../AnalisisBox.rds")
```

Se pueden ver las diferentes gráficas de juste para cada comunidad, como son muchos gráficos se muestra solo uno, pero se puede ver que el resto muestran resultados similares. Ponemos el caso de **Andalucía**

```{r Gráfico 6, out.height="30%", out.width="70%"}
AnalisisBox[[2]]
```

Entonces, tras ver que el modelo aproxima de forma razonable los datos prepandemia, hay razones para confiar en las predicciones, las cuales se pueden interpretar como los datos de pernoctaciones que hubieran sucedido en esos meses siguientes a febrero de $2020$ si la pandemia no hubiera azotado.

Lo más interesante ocurre si comparamos esas predicciones con los datos posteriores a la pandemia. Si bien es cierto que hay algunas comunidades para las cuales las predicciones no se ajustan en nada (son los casos de las ciudades autónomas) en el resto de casos se puede ver como la predicción y el valor postpandemia son iguales solo que con cifras algo menores menores.

```{r Gráfico 7, echo=FALSE, out.height="30%", out.width="70%"}
AnalisisBox[[18]]
```

```{r Gráfico 8, echo=FALSE, out.height="30%", out.width="70%"}
AnalisisBox[[13]]
```

### Imputación de datos

Mediante el modelo ARIMA previamente entrenado, se imputan los valores del periodo comprendido entre marzo de 2020 y febrero de 2021, sustituyendo los datos originales afectados por la pandemia por las predicciones del modelo.
Así se obtiene una serie temporal más coherente y continua, almacenada en el nuevo data frame `df_Turismo_corregido`. 

```{r Dataframe con las predicciones, echo=FALSE}
AnalisisBox <- readRDS("../AnalisisBox.rds")

df <- data.frame(matrix(nrow = 0, ncol = 12))
ccaa <- levels(df_Turismo$CCAA)
j <- 1

for (x in AnalisisBox){
  if (inherits(x, "forecast")){
    df[j, ] <- x$mean 
    rownames(df)[j] <- ccaa[[j]]
    j <- j + 1
  }
}

```

```{r Imputación de los datos con las predicciones, include=FALSE}
# Copia del data frame original
df_Turismo_corregido <- df_Turismo

# Ordenar por CCAA y Periodo para tener los meses en orden dentro de cada comunidad
df_Turismo_corregido <- df_Turismo_corregido %>%
  arrange(CCAA, Periodo)

# Definir rango COVID (12 meses: 2020-03 a 2021-02)
inicio_covid <- as.Date("2020-03-01")
fin_covid    <- as.Date("2021-02-01")

# Número de meses que tenemos predichos (columnas de df)
n_meses <- ncol(df)

# Comunidades en el mismo orden para df
ccaa_niveles <- levels(df_Turismo_corregido$CCAA)

# Opcional pero útil: asignar nombres de fila a df según las CCAA
if (nrow(df) == length(ccaa_niveles)) {
  rownames(df) <- ccaa_niveles
}

# Bucle: para cada CCAA, sustituir los 12 meses de COVID por los del df
for (ccaa_actual in ccaa_niveles) {
  
  # índices de las filas de esa CCAA en el periodo COVID
  idx <- which(
    df_Turismo_corregido$CCAA   == ccaa_actual &
    df_Turismo_corregido$Periodo >= inicio_covid &
    df_Turismo_corregido$Periodo <= fin_covid
  )
  
  # si hay tantas filas como meses predichos, sustituimos
  if (length(idx) == n_meses && ccaa_actual %in% rownames(df)) {
    df_Turismo_corregido$Total[idx] <- as.numeric(df[ccaa_actual, 1:n_meses])
  }
}

```

## OCUPACIÓN

El segundo conjunto de datos corresponde a la ocupación por sectores económicos en España, obtenido del INE. Contiene el número de personas ocupadas (en miles) por comunidad o ciudad autónoma, sector y periodo trimestral.

```{r, include=FALSE}
dim(df_Ocupacion)
```

El dataset está compuesto por 21.300 observaciones (filas) y 5 variables (columnas), cuyos nombres son claros y representativos, lo que facilita su comprensión y manipulación posterior.

Las variables incluidas son:

- **Sexo**. Variable categórica que presenta el valor “mujer”, “hombre” y “ambos sexos”.

- **Comunidades.y.Ciudades.Autónomas**. Variable categórica que incluye las comunidades Españolas y el total nacional.

- **Sector.económico**. Variable categórica que clasifica la actividad económica en agricultura, industria, construcción o servicios. 

- **Periodo**. Variable tipo fecha que muestra el año y trimestre.

- **Total**. Variable numérica que muestra las personas ocupadas (en miles).

Como primer paso, se utilizó la función `glimpse()` para revisar la estructura del dataset. Se comprobó que todas las columnas se importaron como tipo carácter, por lo que será necesario ajustar los tipos de datos en los siguientes pasos.

```{r, include=FALSE}
df_Ocupacion %>% glimpse()
```

### Limpieza

Para limpiar y preparar la base de datos de ocupación, ha sido necesario realizar los siguientes pasos:

1. Eliminar la columna “Sexo”.

2. Eliminar números y carácteres especiales de los nombres de las comunidades. Además de filtrar y eliminar el valor “Total nacional” de la variable CCAA, por ser redundante respecto al resto de comunidades y ciudades autónomas. Posteriormente, esta variable se convierte a tipo factor.

3. Filtrar los registros correspondientes al sector “Servicios” dentro de la columna Sector.económico. Dado que la tabla se centrará exclusivamente en este sector, la variable se elimina por resultar redundante.

4. Convertir la variable “Periodo” del formato YYYYTQ a un formato de fecha trimestral mediante la función `as.yearqtr()`.

5. Normalizar la variable “Total”, eliminando la palabra “miles” y los puntos de millares, sustituyendo la coma decimal por punto, convirtiendo los valores a numéricos y multiplicándolos por 1.000 para expresarlos en personas. De este modo, se mantiene la coherencia de escala con la base de datos de turismo.

```{r}
df_Ocupacion_clean <-  df_Ocupacion %>% 
  #1
  filter(Sexo == "Ambos sexos") %>% 
  select(-Sexo) %>%
  #2
  rename(CCAA=Comunidades.y.Ciudades.Autónomas) %>% 
  mutate(CCAA = str_replace(CCAA, "^[0-9]+\\s+", ""), 
  CCAA = str_replace(CCAA, 
                     "^\\s*([^,]+?)\\s*,\\s*([^,]+?)\\s*$", "\\2 \\1")) %>%
  filter(CCAA != "Total Nacional") %>%
  mutate(CCAA=as.factor(CCAA)) %>% 
  #3
  filter(Sector.económico=='Servicios') %>% 
  select(-Sector.económico) %>% 
  #4 
  mutate(Periodo = str_replace(Periodo, "T", "-"), 
    Periodo = as.yearqtr(Periodo)) %>% 
  #5
  mutate(
    Total=str_replace_all(Total, '\\.',""),
    Total = str_replace(Total, ",", "."),
    Total = as.numeric(Total)*1000 
  ) %>% 
  arrange(CCAA, Periodo)
```

### Análisis

A continuación, se representa la **evolución trimestral del empleo nacional en el sector servicios**. Para ello, se agrupan los datos por periodo y se calcula el total de personas ocupadas, generando una serie temporal mediante un gráfico de líneas.

```{r Gráfico 9, echo=FALSE, out.height="30%", out.width="70%"}
# Total nacional por trimestre
ocup_nacional <- df_Ocupacion_clean %>%
  group_by(Periodo) %>%
  summarise(Total = sum(Total, na.rm = TRUE), .groups = "drop")

ggplot(ocup_nacional, aes(Periodo, Total)) +
  geom_line(linewidth = 0.8) +
  scale_y_continuous(labels = label_comma(big.mark = ".", decimal.mark = ","))+
  labs(title = 
         "Ocupación total nacional en sector servicios",
       x = "Periodo", y = "Personas ocupadas") +
  theme_minimal()
```

Se observa una caída entre 2010 y 2014, posiblemente asociada a los efectos de la crisis de 2008, seguida de una recuperación sostenida hasta 2019.

En 2020 se produce un descenso notable debido al impacto de la pandemia, tras lo cual la ocupación retoma una tendencia creciente, alcanzando niveles superiores a los anteriores.

Además, se aprecia una estacionalidad clara, con aumentos recurrentes en determinados trimestres, probablemente vinculados a la temporada turística.

Además, también se analiza la **evolución trimestral del empleo en el sector servicios por Comunidad Autónoma**, agrupando los datos por región y periodo. El gráfico permite comparar la dinámica laboral entre territorios a lo largo del tiempo.

```{r Gráfico 10, echo=FALSE ,out.height="30%", out.width="90%"}
ocup_ccaa <- df_Ocupacion_clean %>%
  group_by(CCAA, Periodo) %>%
  summarise(Total = sum(Total, na.rm = TRUE), .groups = "drop")

ggplot(ocup_ccaa, aes(Periodo, Total)) +
  geom_line(linewidth = 0.5) +
  facet_wrap(~ CCAA, scales = "free_y", ncol = 3) +
  scale_y_continuous(labels = label_comma(big.mark = ".", decimal.mark = ","))+
  labs(title = 
         "Ocupación en el sector servicios por Comunidad Autónoma (trimestral)",
       x = "Periodo", y = "Personas ocupadas") +
  theme_minimal() +
  theme(panel.spacing = unit(1, "lines"),
        strip.text = element_text(size = 9))

```

Se observa una tendencia al alza más pronunciada en comunidades como Andalucía, Canarias, Madrid y Cataluña, principales motores del sector servicios. Destaca una fuerte estacionalidad en Illes Balears, asociada a la actividad turística, mientras que en la mayoría de regiones la evolución es más estable y con un crecimiento moderado tras la pandemia.

### Detección de outliers

```{r, include=FALSE}
outliers_sigma3_est_oc <- df_Ocupacion_clean %>%
  mutate(Trimestre = quarter(as.Date(Periodo), with_year = FALSE)) %>%
  group_by(CCAA, Trimestre) %>%
  mutate(
    es_outlier_sigma3 = Sigma3_est(Total)
  ) %>%
  ungroup()
```

```{r, include=FALSE}
outliers_hampel_est_oc <- df_Ocupacion_clean %>%
  mutate(Trimestre = quarter(as.Date(Periodo), with_year = FALSE)) %>%
  group_by(CCAA, Trimestre) %>% 
  mutate(
    es_outlier_hampel = Hampel_est(Total)
  ) %>%
  ungroup()
```

```{r, include=FALSE}
outliers_boxplot_est_oc <- df_Ocupacion_clean %>%
  mutate(Trimestre = quarter(as.Date(Periodo), with_year = FALSE)) %>%
  group_by(CCAA, Trimestre) %>%
  mutate(
    es_outlier_boxplot = Boxplot_est(Total)
  ) %>%
  ungroup()
```

Aplicando los tres métodos de detección de valores atípicos, al igual que en la base de datos del turismo, se obtiene el siguiente número de outliers identificados por cada método:

```{r, echo=FALSE}
df_outliers_oc <- df_Ocupacion_clean %>%
  mutate(Trimestre = quarter(as.Date(Periodo), with_year = FALSE)) %>% 
  group_by(CCAA, Trimestre) %>%
  mutate(
    out_hampel  = Hampel_est(Total),
    out_boxplot = Boxplot_est(Total),
    out_sigma3  = Sigma3_est(Total)
  ) %>%
  ungroup()

tabla_outliers_ccaa_oc <- df_outliers_oc %>%
  group_by(CCAA) %>%
  summarise(
    n_hampel  = sum(out_hampel,  na.rm = TRUE),
    n_boxplot = sum(out_boxplot, na.rm = TRUE),
    n_sigma3  = sum(out_sigma3,  na.rm = TRUE)
  ) %>%
  arrange(desc(n_hampel))

tabla_outliers_ccaa_oc
```

El número de valores atípicos detectados en la serie de ocupación es reducido y no presenta un patrón sistemático entre comunidades autónomas. En la mayoría de los casos, estas observaciones reflejan variaciones reales del empleo, asociadas al crecimiento estructural del mercado laboral o a episodios económicos concretos, como la crisis de 2008.

A diferencia de lo ocurrido en la base de datos turística —donde los outliers correspondientes al periodo de la pandemia de la COVID-19 se eliminaron por representar una disrupción excepcional—, en este caso se considera que las fluctuaciones detectadas forman parte del comportamiento normal de la serie.

Por tanto, no se eliminarán las observaciones atípicas y se mantendrán en el análisis, tomando como referencia el método de detección 3-sigma, que ofrece una estimación más estable y coherente con la naturaleza de estos datos.

# ANÁLISIS BIVARIANTE

En esta sección se abordará el análisis bivariante, con el objetivo de relacionar las bases de datos de turismo y ocupación para estudiar posibles vínculos entre ambas variables.

Antes de combinar los conjuntos de datos, será necesario estandarizar ciertas variables con el fin de garantizar una fusión correcta (merge) y obtener un marco de datos coherente para el análisis conjunto.

Así pues, se convierte la variable Periodo al formato año-trimestre, luego se agrupan los datos por comunidad y periodo, y se calcula el total de turistas por trimestre y CCAA. Finalmente, se ordenan los registros por comunidad y periodo para facilitar el merge posterior.

```{r, echo=FALSE}
turismo_to_merge <- df_Turismo_corregido %>%
  mutate(Periodo = as.yearqtr(Periodo)) %>%
  group_by(CCAA, Periodo) %>%
  summarise(Total_turismo = sum(Total, na.rm = TRUE), .groups = "drop") %>% 
  arrange(CCAA, Periodo)
```

Mediante la función `merge()`, se unen ambos conjuntos de datos utilizando como claves comunes las variables CCAA y Periodo.

Antes de la unión, en la base de ocupación se renombra la variable Total como Numero_ocupados para distinguirla del total de turistas y evitar ambigüedades en el nuevo dataset combinado (df_Turismo_Ocupacion).

```{r}
df_Turismo_Ocupacion <- merge(
  x = turismo_to_merge,
  y = (df_Ocupacion_clean %>% 
    rename(Numero_ocupados = Total)),
  by.x = c("CCAA", "Periodo"),
  by.y = c("CCAA", "Periodo"))
```

Finalmente, una vez preparadas y combinadas las bases de datos, se guardan los objetos resultantes en formato `.RData`.

Esto permite conservar los datos limpios y listos para su análisis, facilitando su carga posterior sin necesidad de repetir el proceso de limpieza y fusión.

```{r, include=FALSE}
#save(df_Turismo_Ocupacion, file='Data/df_Turismo_Ocupacion.RData')
#save(df_Turismo, file='Data/df_Turismo_clean_mensual.RData')
```

-------

**Correlaciones de Pearson**

Como primer paso, se calcula la correlación de Pearson entre el número de turistas y el empleo en el sector servicios para cada Comunidad Autónoma.

El objetivo es medir la intensidad y dirección de la relación lineal entre ambas variables, obteniendo tanto el coeficiente de correlación como su p-valor para evaluar la significatividad estadística.

Además, se incorpora un indicador de nivel de significación (p < 0.05), que permite identificar en qué comunidades la relación es estadísticamente relevante. Los resultados se ordenan de mayor a menor correlación, destacando aquellas regiones donde el vínculo entre turismo y empleo es más fuerte y significativo.

```{r, echo=FALSE}
correlaciones_por_comunidad <- df_Turismo_Ocupacion %>%
  group_by(CCAA) %>%
  summarise(
    resultado = list(cor.test(Total_turismo, 
                              Numero_ocupados, method = "pearson"))) %>%
  mutate(
    cor = map_dbl(resultado, "estimate"),
    p_value = map_dbl(resultado, "p.value")
  ) %>%
  select(CCAA, cor, p_value) %>%
  arrange(desc(cor)) %>% 
   mutate(sign = ifelse(p_value <= 0.05, "Sí", "No"))

```

```{r Gráfico 11, echo=FALSE, out.height="20%", out.width="60%"}
ggplot(correlaciones_por_comunidad, aes(x = reorder(CCAA, cor), y = cor)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Correlación entre Turismo y Ocupación por Comunidad Autónoma",
       x = "Comunidad Autónoma", y = "Coeficiente de correlación de Pearson") +
  theme_minimal()

```

Se observa que Illes Balears presenta la mayor correlación positiva (r = 0.705) entre turismo y empleo en el sector servicios, reflejando su fuerte dependencia del turismo estival. En el extremo opuesto, Melilla muestra una correlación muy baja (r = 0.083), probablemente por una menor relación directa entre la llegada de turistas y el empleo local.

En general, las correlaciones son positivas pero de magnitud moderada, indicando que ambas variables tienden a evolucionar conjuntamente, aunque con distinta intensidad según la región.

En la mayoría de comunidades, la relación es estadísticamente significativa (p < 0.05), mientras que en Ceuta, La Rioja, Cataluña y Asturias no se observa significatividad, posiblemente por el menor peso del turismo en su economía o por una mayor volatilidad en los datos.

Por último, cabe señalar que la correlación no implica causalidad: los resultados reflejan asociación, pero no necesariamente una relación directa de causa y efecto.

**Análisis de regresión lineal simple**

Además, modelamos para cada comunidad una regresión  simple con el objetivo de conocer la **bondad de ajuste** (`R^2`), lo cual permitea valorar qué proporción de la variabilidad en el empleo es explicada por el turismo.

```{r, echo=FALSE}
modelos_por_ccaa <- df_Turismo_Ocupacion %>%
  group_by(CCAA) %>%
  do(modelo = lm(Numero_ocupados ~ Total_turismo, data = .)) %>%
  mutate(
    R2 = summary(modelo)$r.squared,
    R2         = summary(modelo)$r.squared,
    pendiente  = coef(modelo)[2], #β₁
    intercepto = coef(modelo)[1], #β₀
    p_value    = summary(modelo)$coefficients[2, 4]
  ) %>%
  select(CCAA, pendiente, intercepto, R2, p_value) %>% 
  arrange(desc(R2))
```
```{r Gráfico 12, echo=FALSE, out.height="30%", out.width="70%"}
año_ref <- 2024

nuts2 <- gisco_get_nuts(year = año_ref,
                        resolution = 20,
                        nuts_level = 2,
                        country = "ES") %>%
         select(NUTS_ID, NAME_LATN)

nuts2 <- nuts2 %>%
  mutate(NAME_LATN = recode(
    NAME_LATN,
    "Comunidad Valenciana"      = "Comunitat Valenciana",
    "Castilla-La Mancha"        = "Castilla - La Mancha",
    "Ciudad Autónoma de Ceuta"  = "Ceuta",
    "Ciudad Autónoma de Melilla"= "Melilla"
  ))

R2_por_ccaa <- modelos_por_ccaa %>%
  select(CCAA, R2)

mapa_R2 <- nuts2 %>%
  left_join(R2_por_ccaa, by = c("NAME_LATN" = "CCAA"))

ggplot(mapa_R2) +
  geom_sf(aes(fill = R2), color = "white") +
  scale_fill_gradientn(
    colours = hcl.colors(7, "Inferno", rev = TRUE),
    name = expression(R^2)
  ) +
  labs(
    title = "Bondad de ajuste por CCAA",
    subtitle = "Coeficiente de determinación (R²)",
    x = NULL, y = NULL
  ) +
  theme_minimal()

```

En general, se observa que los valores son moderados o bajos, lo que indica que, aunque existe cierta relación entre ambas variables, el turismo no explica completamente la evolución del empleo, y probablemente influyen otros factores económicos o estructurales.

Las comunidades con mayor ajuste del modelo son Islas Baleares ($R^2 = 0.498$), Canarias ($R^2 = 0.388$), Madrid ($R^2 = 0.276$) y Aragón ($R^2 = 0.234$),donde donde el comportamiento del empleo en el sector servicios parece estar más vinculado a la actividad turística, mostrando una relación más clara entre ambas variables en comparación con el resto de regiones.

Por el contrario, en Ceuta y Melilla ($R^2 \approx 0$) y Asturias ($R \approx 0.045$) el modelo lineal apenas explica la variación en el empleo, lo que sugiere una relación débil o inexistente entre ambas variables en estas regiones.

A partir del modelo de regresión lineal calculado anteriormente, se estima la **elasticidad** del empleo respecto al turismo, utilizando la pendiente de la recta de regresión como medida del impacto del turismo sobre el empleo en cada comunidad autónoma.

```{r, echo=FALSE}
elasticidad_por_ccaa <- df_Turismo_Ocupacion %>%
  group_by(CCAA) %>%
  summarise(
    media_turismo = mean(Total_turismo, na.rm = TRUE),
    media_ocupados = mean(Numero_ocupados, na.rm = TRUE)
  ) %>%
  left_join(modelos_por_ccaa, by = "CCAA") %>%
  mutate(
    elasticidad = pendiente * (media_turismo / media_ocupados),
    int=ifelse(elasticidad>=1, 'Elástico', 'Inelástico') #interpretación
  ) %>%
  select(CCAA, elasticidad, int) %>% 
  arrange(desc(elasticidad))
  
elasticidad_por_ccaa

```

Los valores de elasticidad, comprendidos entre  0.01891369 y 0.3962694 , muestran que en todas las comunidades autónomas la relación entre turismo y empleo es inelástica (ya que <1), es decir, el empleo en el sector servicios apenas varía ante los cambios en la actividad turística. Esto sugiere que un aumento del turismo no se traduce proporcionalmente en un mayor nivel de empleo.

Esta baja respuesta puede deberse a que parte del empleo es estructural o fijo, a la existencia de desfases temporales entre el incremento del turismo y la contratación de personal, o a que las variables se miden en frecuencias distintas (mensual para el turismo y trimestral para el empleo), lo que suaviza la relación observada.

En regiones como Canarias ($\approx 0.396$), donde la elasticidad es algo mayor, el empleo muestra una mayor sensibilidad a las variaciones del turismo, coherente con su elevada dependencia económica de esta actividad.

Aunque las correlaciones y la bondad de ajuste indicaban una relación fuerte y significativa entre turismo y empleo, las elasticidades calculadas son bajas. Esto no representa una contradicción, sino una diferencia en la interpretación: mientras la correlación mide la fuerza de la relación, la elasticidad cuantifica su intensidad relativa.

En otras palabras, aunque el turismo y el empleo evolucionan de forma coordinada, el impacto porcentual del turismo sobre el empleo es reducido, lo que sugiere que otros factores —como la estacionalidad o la estabilidad estructural del mercado laboral— también influyen en la evolución del empleo.


# CONCLUSIONES

# ANEXOS