---
title: "Limpieza_Datos"
author: "Iyán Álvarez, Azahara Martínez, Juan Alcaraz Otón"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Librerias}
library(dplyr)
library(stringr)
library(lubridate)
library(tidyr)
library(tidyverse)
library(zoo)
```

## IMPORTACIÓN

```{r Enlaces de descarga}
url_ocupacion <- "https://www.ine.es/jaxiT3/files/t/es/csv_bdsc/65311.csv?nocab=1"
url_turismo <- "https://www.ine.es/jaxiT3/files/t/es/csv_bdsc/67190.csv?nocab=1"
```

```{r Codificación de los archivos}
guess_encoding(url_turismo)
guess_encoding(url_ocupacion)
```

```{r Importación}
df_Turismo <- read.csv(url_turismo,
                       header = TRUE,
                       sep = ";",
                       dec = ".",
                       encoding = "UTF-8")

df_Ocupacion <- read.csv(url_ocupacion,
                       header = TRUE,
                       sep = ";",
                       dec = ".",
                       encoding = "UTF-8")
```

# CARACTERÍSTICAS GENERALES

## TURISMO

```{r}
df_Turismo %>% glimpse()
```

```{r}
sapply(df_Turismo, function(x) length(unique(x)))
```
```{r}
print(unique(df_Turismo$Comunidades.y.Ciudades.Autónomas))
print(unique(df_Turismo$Provincias))
```
Elinamos las filas que corresponden al total nacional y a las Comunidades Autónomas ya que son redundantes y se pueden sacar a partir del resto de datos si se necesitaran.

```{r}
df_Turismo <- df_Turismo %>%
  select(-Totales.Territoriales)%>%
  filter(str_trim(Comunidades.y.Ciudades.Autónomas) != "", str_trim(Provincias) != "")
```

Como hemos visto arriba hay que arreglar los tipos de datos, empezamos con las fechas

```{r}
df_Turismo <- df_Turismo %>%
  mutate(Periodo = as.yearmon(str_replace(Periodo, "M", "-")))
```

Limpiamos los nombres #TODO ARREGLAR LOS NOMBRES, LAS COMAS DE DETRAS Y LOS DOS IDIOMAS (VER UNIQUES)

```{r}
df_Turismo <- df_Turismo %>% 
  mutate(Comunidades.y.Ciudades.Autónomas = str_replace(Comunidades.y.Ciudades.Autónomas, "^[0-9]+\\s+", "")) %>% 
  mutate(Provincias = str_replace(Provincias, "^[0-9]+\\s+", ""))
```


## OCUPACIÓN

```{r}
df_Ocupacion %>% glimpse()
```


# LIMPIEZA BASE DE DATOS 

##TURISMO 

Ahora voy a toquetear las fechas

```{r}
df_Turismo <- df_Turismo%>%
  separate(col=Periodo,into=c('Año', 'Mes'), sep='M')

df_Turismo <- df_Turismo %>%
  mutate(fecha = ym(paste0(Año, "-", Mes)))
```

## OCUPACIÓN

```{r}
df_Ocupacion_clean <- df_Ocupacion %>%
  dplyr::filter(Comunidades.y.Ciudades.Autónomas != "Total Nacional") %>% #elimino los totales pq son redundantes
  dplyr::filter(Sector.económico == "Servicios") %>% #filtro para quedarme solo con el sector servicios que es el que me interesa
  mutate(Comunidades.y.Ciudades.Autónomas = str_replace(Comunidades.y.Ciudades.Autónomas, "^[0-9]+\\s+", "")) %>%#elimino la enumeracion de los nombres de las comunidades
  select(-Sexo, -Sector.económico) %>% 
  mutate(Periodo = as.yearqtr(str_replace(Periodo, "T", "-"))) %>%
  rename('Comunidades Autónomas'= Comunidades.y.Ciudades.Autónomas)

```

Para tener una imagen general de como se mueve la ocupación
```{r}

```

