---
title: "Limpieza_Datos"
author: "Iyán Álvarez, Azahara Martínez, Juan Alcaraz Otón"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Librerias}
library(lubridate)
library(tidyr)
library(tidyverse)
library(scales)
library(dplyr)
library(stringr)
```

# INTRODUCCIÓN

Para el desarrollo del análisis, se han utilizado dos bases de datos principales. La primera contiene información relacionada con el turismo en España, desglosada por comunidades autónomas y provincias, e incluye variables como el número de viajeros y pernoctaciones registradas a lo largo de varios años. La segunda base de datos corresponde al sector servicios, específicamente a la ocupación en dicho sector, que se analizará posteriormente para establecer relaciones con la evolución del turismo.

# IMPORTACIÓN Y LIMPIEZA

Con el fin de garantizar que los datos utilizados estén siempre actualizados, se ha optado por realizar la importación directamente desde la URL de origen, en lugar de utilizar copias locales. De este modo, si los archivos son modificados o actualizados en la fuente oficial, el código podrá acceder automáticamente a la versión más reciente.

```{r Enlaces de descarga}
url_ocupacion<-"https://www.ine.es/jaxiT3/files/t/es/csv_bdsc/65311.csv?nocab=1"
url_turismo<-"https://www.ine.es/jaxiT3/files/t/es/csv_bdsc/67190.csv?nocab=1"
```

Antes de proceder a la carga definitiva, se ha comprobado la codificación (encoding) de cada archivo, con el objetivo de evitar posibles problemas de lectura o visualización de caracteres especiales en las tablas. Esto se ha realizado aplicando la función correspondiente para identificar el tipo de codificación de cada dataset.

```{r Codificación de los archivos}
guess_encoding(url_turismo)
guess_encoding(url_ocupacion)
```

Finalmente, los datos se han importado utilizando la función read_csv(), creando dos dataframes principales:

```{r Importación}
df_Turismo <- read.csv(url_turismo,
                       header = TRUE,
                       sep = ";",
                       encoding = "UTF-8")

df_Ocupacion <- read.csv(url_ocupacion,
                       header = TRUE,
                       sep = ";", #TODO, ESTA SI QUE TIENE DECIMAL
                       encoding = "UTF-8")
```

# CARACTERÍSTICAS GENERALES

## TURISMO

Una vez importados los datos, se procede al análisis de las características generales del primer conjunto, correspondiente al turismo en España. Este dataset recopila información sobre el número de viajeros y las pernoctaciones registradas a lo largo del tiempo, desglosadas por comunidades y provincias.

Las variables incluidas son las siguientes:

- Totales.Territoriales: columna con un único valor (“Total Nacional”). No aporta información relevante para el análisis, por lo que se eliminará en fases posteriores.

- Comunidades.y.Ciudades.Autónomas: identifica la comunidad o ciudad autónoma correspondiente a cada registro.

- Provincias: especifica la provincia asociada a cada comunidad.

- Viajeros.y.pernoctaciones: indica el tipo de registro (viajeros o pernoctaciones).

- Residencia..Nivel.1: variable redundante que contiene el valor “Total” en todas sus observaciones; se eliminará del dataset.

- Residencia..Nivel.2: indica el origen de los viajeros, diferenciando entre residentes en España y residentes en el extranjero.

- Periodo: recoge el año y el mes al que corresponde cada observación.

- Total: valor numérico asociado al tipo de registro (viajeros o pernoctaciones) en el periodo y territorio determinados.

En el momento de la importación, todas las variables se cargaron inicialmente con tipo de dato character. Posteriormente, durante la fase de preparación de los datos, se realizará la conversión de aquellas variables que correspondan a fechas, factores o valores numéricos, con el fin de facilitar su análisis estadístico y gráfico.

Como primer paso del análisis exploratorio, se utilizó la función glimpse() (del paquete dplyr) para obtener una visión general de la estructura del dataset.

Gracias a esta función se pudo observar que todas las columnas se importaron como tipo carácter, por lo que será necesario realizar conversiones de tipo en etapas posteriores.

```{r}
df_Turismo %>% glimpse()
```

La columna Total presenta puntos como separadores de miles, por lo que, para garantizar cálculos correctos, se eliminaron.

```{r}
df_Turismo <- mutate(df_Turismo, Total = str_replace_all(Total, "\\.", ""))
```

Con el objetivo de revisar el contenido de cada variable y detectar posibles inconsistencias, se aplicó la función sapply() combinada con unique() al dataframe del turismo.

Esta operación permitió obtener los valores únicos presentes en cada una de las columnas, facilitando la identificación de errores o redundancias en los datos.

A partir de este análisis se obtuvieron las siguientes observaciones:

- Totales.Territoriales presenta un único valor (“Total nacional”), por lo que se confirma que esta variable no aporta información útil y será eliminada.

- Comunidades.y.Ciudades.Autónomas contiene 20 valores únicos, cuando en realidad existen 19 comunidades y ciudades autónomas, lo que sugiere la posible presencia de algún error o duplicado en los nombres.

- Provincias muestra 51 valores únicos, aunque en España existen 50 provincias, por lo que también será necesario revisar esta variable.

- Viajeros.y.Pernoctaciones incluye correctamente 2 valores distintos, lo que confirma su coherencia.

- Residencia..Nivel.1 tiene un único valor (“Total”), por lo que se considera redundante.

- Residencia..Nivel.2 presenta 3 valores únicos, cuando solo deberían existir 2 categorías (residentes en España y residentes en el extranjero), lo que indica un posible error en la codificación de algunos registros.

- Las variables Periodo y Total no presentan incidencias destacables en esta fase.

Este análisis preliminar permitió detectar columnas redundantes y posibles errores de codificación que deberán corregirse en la fase de limpieza del dataset antes de continuar con el análisis exploratorio.

```{r}
sapply(df_Turismo, function(x) length(unique(x)))
```

Tras analizar los valores únicos, se observó que las variables Comunidades.y.Ciudades.Autónomas, Provincias y Residencia2.Nivel.2 presentaban registros vacíos o en blanco, lo que explica las discrepancias detectadas anteriormente.

Estos valores se eliminarán en la fase de limpieza del dataset.

```{r}
print(unique(df_Turismo$Comunidades.y.Ciudades.Autónomas))
print(unique(df_Turismo$Residencia..Nivel.2))
```

Se eliminaron las filas correspondientes al total nacional y a las comunidades autónomas, ya que esta información es redundante y puede obtenerse fácilmente a partir del resto de los registros si fuera necesario.

Además, se eliminó la columna Totales.Territoriales y aquellas filas que contenían valores vacíos en la variables Comunidades.y.Ciudades.Autónomas, utilizando las funciones select() y filter() del paquete dplyr.

```{r}
df_Turismo <- df_Turismo %>%
  select(-Totales.Territoriales) %>%
  filter(str_trim(Comunidades.y.Ciudades.Autónomas) != "")
```

Para simplificar el análisis y la interpretación gráfica, se decidió agrupar la información a nivel de comunidades y ciudades autónomas.

Aunque disponer de datos desagregados por provincia podría resultar interesante para estudios más específicos, en este trabajo se opta por un enfoque autonómico que permite una visión más general y comparativa del turismo en España.

```{r}
df_Turismo <- df_Turismo %>%
  select(-Provincias)
```

Como ya se ha mencionado, la columna Residencia..Nivel.1 contiene un único valor (“Total”) en todas sus observaciones, por lo que no aporta información relevante al análisis.

Se decidió eliminarla junto con las filas vacías de la variable Residencia..Nivel.2.

```{r}
unique(df_Turismo$Residencia..Nivel.1)

df_Turismo <- df_Turismo %>% 
  select(-Residencia..Nivel.1) %>% 
  filter(str_trim(Residencia..Nivel.2) != "")
```

Para continuar con el análisis, se creó un nuevo conjunto de datos agregado a nivel de comunidad autónoma.

```{r}
df_Turismo <- df_Turismo %>%
  group_by(Comunidades.y.Ciudades.Autónomas, Periodo, Viajeros.y.pernoctaciones, Residencia..Nivel.2)
```

Como se observó en la exploración inicial, todas las columnas se habían importado como tipo carácter, por lo que, para facilitar el análisis temporal, se modificó el tipo de dato de la variable Periodo, convirtiéndola a formato fecha mediante la función ym(), tras reemplazar el carácter “M” por un guion con str_replace().

```{r}
df_Turismo <- df_Turismo %>%
  mutate(Periodo = str_replace(Periodo, "M", "-"), 
    Periodo = ym(Periodo))
```

A continuación, se convirtieron a tipo factor las variables Viajeros.y.pernoctaciones y Residencia..Nivel.2 (renombrada como Residencia), ya que representan categorías con un número limitado de valores posibles.

Transformarlas en factores permite optimizar el uso de memoria, facilitar la agrupación y el filtrado de datos y mejorar la interpretación en análisis estadísticos y representaciones gráficas.

```{r}
df_Turismo <- df_Turismo %>% 
  mutate(Viajeros.y.pernoctaciones=as.factor(Viajeros.y.pernoctaciones)) %>% 
  mutate(Residencia..Nivel.2=as.factor(Residencia..Nivel.2)) %>%
  rename(Residencia=Residencia..Nivel.2)

```

Además, se transformó la columna Total a tipo numérico, ya que contiene los valores cuantitativos asociados al número de viajeros o pernoctaciones.
Esta conversión permitirá realizar operaciones estadísticas y cálculos posteriores sin generar errores de tipo de dato.

```{r}
df_Turismo <- df_Turismo %>% 
  mutate(Total=as.numeric(Total))
```

Antes de convertir la variable Comunidades.y.Ciudades.Autónoma (#TODO renombrada como Región) a tipo factor, fue necesario limpiar y estandarizar sus valores.

Se eliminaron los números iniciales, espacios y caracteres innecesarios, y se ajustó el formato de texto para unificar la escritura de los nombres de las comunidades. Además, se determinó la variable como tipo factor.

```{r}
df_Turismo <- df_Turismo %>% 
  mutate(
    Comunidades.y.Ciudades.Autónomas = str_replace(Comunidades.y.Ciudades.Autónomas, "^[0-9]+\\s+", ""),
    Comunidades.y.Ciudades.Autónomas = str_replace(Comunidades.y.Ciudades.Autónomas,                                                   "^\\s*([^,]+?)\\s*,\\s*([^,]+?)\\s*$", "\\2 \\1"),
    Comunidades.y.Ciudades.Autónomas = str_squish(Comunidades.y.Ciudades.Autónomas)
  ) %>%
  mutate(Comunidades.y.Ciudades.Autónomas = as.factor(Comunidades.y.Ciudades.Autónomas))
```

```{r}
#TODO NO ES LO MISMO QUE HAY ARRIBA??? df_Turismo <- df_Turismo %>%
#  mutate(Comunidades.y.Ciudades.Autónomas = as.factor(Comunidades.y.Ciudades.Autónomas))
```

## ANÁLISIS UNIVARIANTE

Como primer paso del análisis univariante, se calcularon los estadísticos descriptivos básicos de las variables incluidas en el dataset mediante la función summary(). 

```{r}
summary(df_Turismo)
```

Aunque al aplicar esta función sobre variables categóricas, no obtenemos información muy relevante a nivel estadístico, muestran la frecuencia de cada categoría, confirmando que los datos son coherentes con lo esperado.

En cuanto a la variable numérica (Total), también se analizó su dispersión mediante la desviación típica:

```{r}
sd(df_Turismo$Total)
```
#TODO POR QUE NA? Esta sd indica que............

Consideramos que analizar el conjunto completo de observaciones puede ocultar las diferencias existentes entre regiones. 

Por ello, se agruparon los datos por comunidad y ciudad autónoma y se calcularon los principales estadísticos descriptivos de la variable Total

```{r}
df_Turismo %>%
  group_by(Comunidades.y.Ciudades.Autónomas) %>%
  summarise(
    media = mean(Total, na.rm = TRUE),
    mediana = median(Total, na.rm = TRUE),
    desviacion_tipica = sd(Total, na.rm = TRUE),
    minimo = min(Total, na.rm = TRUE),
    maximo = max(Total, na.rm = TRUE),
    n_observaciones = n()
  ) %>%
  arrange(desc(media)) %>% 
  print()
```

Dado que inicialmente este dataset contenía espacios en blanco, resulta necesario comprobar que, tras el proceso de limpieza, todos los valores se hayan corregido correctamente. Además, se verifica si existen valores faltantes (NA) en las distintas variables.

```{r}
#Huecos en blanco
sum(df_Turismo == "", na.rm = TRUE)
colSums(df_Turismo == "", na.rm = TRUE)

#NA
anyNA(df_Turismo)
colSums(is.na(df_Turismo))
```

Se confirma que no hay valores faltantes ni espacios en blanco, por lo que el dataset está limpio y listo para el análisis.

## REPRESENTACIÓN GRÁFICA

Para visualizar mejor estos datos, se emplea una representación gráfica. En primer lugar, se analiza el total nacional, con el objetivo de obtener una visión general de las tendencias y dinámicas estacionales presentes en los datos.

En la gráfica se aprecia una tendencia creciente a lo largo del tiempo y una marcada estacionalidad, factores que se estudiarán con mayor profundidad en apartados posteriores. Además, se observan valores atípicos asociados a la pandemia de la COVID-19, que provocaron una fuerte caída en los registros turísticos.

```{r}
nacional_mensual <- df_Turismo %>%
  group_by(Periodo) %>%
  summarise(Total = sum(Total, na.rm = TRUE), .groups = "drop")

ggplot(nacional_mensual, aes(Periodo, Total)) +
  geom_line(linewidth = 0.8) +
  scale_y_continuous(labels = label_comma(big.mark = ".")) +
  labs(title = "Serie temporal de viajeros y pernoctaciones españolas por mes",
       x = "Periodo", y = "Total",
       color = "Tipo") +
  theme_minimal()
```

A continuación, se representa gráficamente la serie temporal correspondiente a cada comunidad y ciudad autónoma, con el objetivo de observar la evolución del turismo en cada territorio y comparar sus comportamientos a lo largo del tiempo.

```{r}
ca_mensual <- df_Turismo %>%
  group_by(Comunidades.y.Ciudades.Autónomas, Periodo) %>%
  summarise(Total = sum(Total, na.rm = TRUE), .groups = "drop")

ggplot(ca_mensual, aes(Periodo, Total)) +
  geom_line(linewidth = 0.6) +
  facet_wrap(~ Comunidades.y.Ciudades.Autónomas, scales = "free_y", ncol = 3) +
  scale_y_continuous(labels = label_comma(big.mark = ".")) +
  labs(title = "Serie temporal por Comunidad Autónoma",
       x = "Periodo", y = "Total") +
  theme_minimal()
```

#TODO ESTO ES SEGÚN LO QUE YO HE VISTO EN LOS GRAFICOS, CREO QUE ESTARÁ BIEN PERO REVISAR

En términos generales, todas las comunidades presentan una fuerte estacionalidad, con picos de actividad turística durante los meses de verano.

Sin embargo, al analizar la tendencia a largo plazo, se aprecia que la Comunidad de Madrid, el País Vasco y Canarias muestran una tendencia claramente creciente, lo que indica un aumento sostenido del turismo en estos territorios.
Por el contrario, comunidades como Ceuta presentan una evolución más estacionaria, sin una tendencia ascendente evidente.

También se observan diferencias en la variabilidad de las series: en comunidades como Illes Balears, Asturias, Andalucía o la Comunitat Valenciana se aprecia una heterocedasticidad significativa, es decir, una mayor dispersión de los valores a medida que aumenta el número de turistas.
En cambio, en regiones como Madrid o Canarias, la variabilidad parece mantenerse más constante en el tiempo.

Finalmente, en todas las comunidades se detecta un descenso abrupto en 2020, correspondiente al impacto de la pandemia de la COVID-19, que afectó de forma notable a la actividad turística.

En el siguiente apartado, se procederá a detectar de forma más formal estos valores atípicos, aplicando el método de detección 3σ de forma estacional (por mes y comunidad autónoma), lo que permite identificar anomalías reales sin confundir los picos de temporada alta o baja con valores atípicos.

```{r}
ca_mensual <- df_Turismo %>%
  group_by(Comunidades.y.Ciudades.Autónomas, Periodo) %>%
  summarise(Total = sum(Total, na.rm = TRUE), .groups = "drop") %>%
  mutate(Mes = month(Periodo, label = TRUE, abbr = TRUE))

outliers_estacionales <- ca_mensual %>%
  group_by(Comunidades.y.Ciudades.Autónomas, Mes) %>%
  mutate(
    media_mes = mean(Total, na.rm = TRUE),
    sd_mes = sd(Total, na.rm = TRUE),
    upLim_mes = media_mes + 3 * sd_mes,
    lowLim_mes = media_mes - 3 * sd_mes,
    es_outlier = ifelse(Total < lowLim_mes | Total > upLim_mes, TRUE, FALSE)
  ) %>%
  ungroup()

resumen_out_estacional <- outliers_estacionales %>%
  group_by(Comunidades.y.Ciudades.Autónomas) %>%
  summarise(
    n_outliers = sum(es_outlier, na.rm = TRUE),
    prop_outliers = mean(es_outlier, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(n_outliers))

resumen_out_estacional

```

Se observa que las comunidades con mayor número de outliers son Castilla-La Mancha, Comunitat Valenciana y La Rioja, con entre 10 y 11 observaciones atípicas cada una. En general, estas comunidades presentan una mayor variabilidad mensual, lo que puede estar asociado a fluctuaciones puntuales en el turismo o a posibles registros anómalos en los datos.

En el extremo opuesto, comunidades como Canarias, Comunidad de Madrid, País Vasco y Navarra no presentan valores atípicos detectables bajo este método, lo que indica una mayor estabilidad temporal en sus series turísticas.

En términos relativos, la proporción de outliers es reducida en todos los casos (inferior al 4%), lo que sugiere que el conjunto de datos es coherente y sin grandes anomalías, más allá de los valores excepcionales ya identificados durante la pandemia de la COVID-19.

A modo de ejemplo, se representa gráficamente la detección de valores atípicos en el caso de Illes Balears, una comunidad que presenta una alta dispersión entre meses y permite comprobar la correcta aplicación del método 3σ estacional, y en la Comunitat Valenciana, una de las regiones con mayor número de outliers.

En ambos casos, se observa que la gran mayoría de los valores atípicos corresponden al periodo de la pandemia de la COVID-19, lo que confirma las anomalías ya detectadas previamente en la serie temporal nacional y autonómica.

```{r}
outliers_estacionales %>%
  filter(Comunidades.y.Ciudades.Autónomas == "Illes Balears") %>%
  ggplot(aes(Periodo, Total)) +
  geom_line(color = "grey60") +
  geom_point(aes(color = es_outlier), size = 1.5) +
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
  labs(
    title = "Detección de valores atípicos estacionales (3σ) - Islas Baleares",
    x = "Periodo", y = "Total", color = "Outlier"
  ) +
  theme_minimal()

outliers_estacionales %>%
  filter(Comunidades.y.Ciudades.Autónomas == "Comunitat Valenciana") %>%
  ggplot(aes(Periodo, Total)) +
  geom_line(color = "grey60") +
  geom_point(aes(color = es_outlier), size = 1.5) +
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
  labs(
    title = "Detección de valores atípicos estacionales (3σ) - Comunidad Valenciana",
    x = "Periodo", y = "Total", color = "Outlier"
  ) +
  theme_minimal()
```


## OCUPACIÓN

El segundo conjunto de datos corresponde a la ocupación por sectores económicos en España, obtenido del INE.Recoge el número de personas ocupadas (en miles) por comunidad o ciudad autónoma, sector y periodo trimestral.

Las variables incluidas son:

- Sexo: único valor (“Ambos sexos”), por lo que se eliminará al no aportar información.

- Comunidades.y.Ciudades.Autónomas: incluye las distintas comunidades y el total nacional, que también se eliminará por ser redundante.

- Sector.económico: distingue cuatro sectores: agricultura, industria, construcción y servicios.

- Periodo: año y trimestre.

- Total: número de personas ocupadas en miles.#TODO SI AQUI ESTAN EXPRESADOS EN MILES Y ALLI DIRECTAMENTE DEBEMOS ESTANDARIZARLO

Este dataset permitirá analizar la evolución del empleo por sectores y regiones, así como su relación con la actividad turística.

Como primer paso, se utilizó la función glimpse() para revisar la estructura del dataset.

Se comprobó que todas las columnas se importaron como tipo carácter, por lo que será necesario ajustar los tipos de datos en los siguientes pasos.

```{r}
df_Ocupacion %>% glimpse()
```
Para limpiar y preparar la base de datos de ocupación, ha sido necesario realizar los siguientes pasos:

1. Eliminar la columna “Sexo”, ya que únicamente contiene el valor “Ambos sexos” y no aporta información relevante para el análisis.

2. Eliminar números y carácteres especiales de los nombres de las comunidades. Además de filtrar y eliminar el valor “Total nacional” de la variable Comunidades.y.Ciudades.Autónomas, por ser redundante respecto al resto de comunidades y ciudades autónomas. Posteriormente, esta variable se convierte a tipo factor.

3. Filtrar los registros correspondientes al sector “Servicios” dentro de la columna Sector.económico. Dado que la tabla se centrará exclusivamente en este sector, la variable se elimina por resultar redundante.

4. Convertir la variable “Periodo” del formato YYYYTQ (por ejemplo, 2022T3) a un formato de fecha trimestral mediante la función ym() del paquete lubridate, tal y como recomendó el profesor.

5. Normalizar la variable “Total”, eliminando la palabra “miles” y los puntos de millares, sustituyendo la coma decimal por punto, convirtiendo los valores a numéricos y multiplicándolos por 1.000 para expresarlos en personas. De este modo, se mantiene la coherencia de escala con la base de datos de turismo.

```{r}
df_Ocupacion_clean <-  df_Ocupacion %>% 
  #1
  select(-Sexo) %>%
  #2
  mutate(Comunidades.y.Ciudades.Autónomas = str_replace(Comunidades.y.Ciudades.Autónomas, "^[0-9]+\\s+", "")) %>%
  filter(Comunidades.y.Ciudades.Autónomas != "Total Nacional") %>%
  mutate(Comunidades.y.Ciudades.Autónomas=as.factor(Comunidades.y.Ciudades.Autónomas)) %>% 
  #3
  filter(Sector.económico=='Servicios') %>% 
  select(-Sector.económico) %>% 
  #4 
  mutate(Periodo = str_replace(Periodo, "M", "-"), 
    Periodo = ym(Periodo)) %>% 
  #5
  mutate(
    Total=str_replace_all(Total, '\\.',""),
    Total = str_replace(Total, ",", "."),
    Total = as.numeric(Total)*1000 
  ) 
```

#TODO LAS FECHAS EN FORMATO YM MUESTRAN DIA PERO AQUI SON TRIMESTRES QUE HACEMOS

Para tener una imagen general de como se mueve la ocupación
```{r}

```

