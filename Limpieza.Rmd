---
title: "Limpieza_Datos"
author: "Iyán Álvarez, Azahara Martínez, Juan Alcaraz Otón"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Librerias}
library(dplyr)
library(stringr)
library(lubridate)
library(tidyr)
library(tidyverse)
library(zoo)
```

## IMPORTACIÓN

```{r Enlaces de descarga}
url_ocupacion <- "https://www.ine.es/jaxiT3/files/t/es/csv_bdsc/65311.csv?nocab=1"
url_turismo <- "https://www.ine.es/jaxiT3/files/t/es/csv_bdsc/67190.csv?nocab=1"
```

```{r Codificación de los archivos}
guess_encoding(url_turismo)
guess_encoding(url_ocupacion)
```

```{r Importación}
df_Turismo <- read.csv(url_turismo,
                       header = TRUE,
                       sep = ";",
                       dec = ".",
                       encoding = "UTF-8")

df_Ocupacion <- read.csv(url_ocupacion,
                       header = TRUE,
                       sep = ";",
                       dec = ".",
                       encoding = "UTF-8")
```

# CARACTERÍSTICAS GENERALES

## TURISMO

```{r}
df_Turismo %>% glimpse()
```

```{r}
sapply(df_Turismo, function(x) length(unique(x)))
```
```{r}
print(unique(df_Turismo$Comunidades.y.Ciudades.Autónomas))
print(unique(df_Turismo$Provincias))
print(unique(df_Turismo$Residencia..Nivel.2))
```
Elinamos las filas que corresponden al total nacional y a las Comunidades Autónomas ya que son redundantes y se pueden sacar a partir del resto de datos si se necesitaran.

```{r}
df_Turismo <- df_Turismo %>%
  select(-Totales.Territoriales)%>%
  filter(str_trim(Comunidades.y.Ciudades.Autónomas) != "", str_trim(Provincias) != "")
```

La columna de Residencia nivel 1 solo se compone de una string que es total entonces no aporta informacion nueva y es redundante.
```{r}
unique(df_Turismo$Residencia..Nivel.1)

df_Turismo <- df_Turismo %>% 
  select(-Residencia..Nivel.1) %>% 
  filter(str_trim(Residencia..Nivel.2) != "")
```
Recordando lo que hicimos antes, observamosAhora vamos a cambiar el tipo de variable al correspondiente.
Como hemos visto arriba hay que arreglar los tipos de datos, empezamos con las fechas

```{r}
df_Turismo <- df_Turismo %>%
  mutate(Periodo = as.yearmon(str_replace(Periodo, "M", "-")))
```

Ahora vamos a poner las comunidades autonomas y provincias(regiones) a tipo factor porque es mejor(explicar por qué es mejor)

```{r}
df_Turismo <- df_Turismo %>% 
  mutate(Viajeros.y.pernoctaciones=as.factor(df_Turismo$Viajeros.y.pernoctaciones)) %>% 
  mutate(Residencia..Nivel.2=as.factor(df_Turismo$Residencia..Nivel.2)) %>% 
  rename(Residencia=Residencia..Nivel.2)

```

La columna de total debemos ponerla en tipo numerico
```{r}
df_Turismo <- df_Turismo %>% 
  mutate(Total=as.numeric(df_Turismo$Total))
```

También deberíamos cambiar a factor las comunidade sy provincias pero primero debemos limpiarlas:

Limpiamos los nombres de las comunidades autonomas y provincias, porque el formato no estaba bien

```{r}
df_Turismo <- df_Turismo %>% 
  mutate(Comunidades.y.Ciudades.Autónomas = str_replace(Comunidades.y.Ciudades.Autónomas, "^[0-9]+\\s+", "")) %>% 
  mutate(Provincias = str_replace(Provincias, "^[0-9]+\\s+", "")) %>% 
  rename(Region=Provincias) %>% 
  mutate(Comunidades.y.Ciudades.Autónomas = str_replace(Comunidades.y.Ciudades.Autónomas,"^\\s*([^,]+?)\\s*,\\s*([^,]+?)\\s*$","\\2 \\1")  %>% str_squish(),Region = str_replace(Region,"^\\s*([^,]+?)\\s*,\\s*([^,]+?)\\s*$","\\2 \\1") %>%  str_squish()) %>% 
  mutate(Region = str_remove(Region, "\\s*/.*$"))

```

Ahora ya podemos cambiarlas a factor
```{r}
df_Turismo <- df_Turismo %>% 
  mutate(Comunidades.y.Ciudades.Autónomas=as.factor(df_Turismo$Comunidades.y.Ciudades.Autónomas)) %>% 
  mutate(Region=as.factor(df_Turismo$Region))
```

VAMOS A HACER UNOS POCOS GRÁFICOS EXPLORATORIOS
Estadisticos descriptivos. Para las variables de tipo factor hacemos un summary y ya (DESCRIBIR) Aunque no aporten mucho a nivel estadistico, tiene sentido lo que vemos en relacion cn lo que esperamos del datframe.
```{r}
summary(df_Turismo)
```
Sin embargo, de la variable numérica si que podemos hacer algun que otro analisis #TODO completar con algo más exploratorio
```{r}
sd(df_Turismo$Total)
```
Como inicialmente en este dataset habian espacios en blanco, vamos a revisar que, una vez todo limpio, debemos comprbar si efectivamente ha quedado todo bien. También comprobamos si hay algún NA
```{r}
#NA
anyNA(df_Turismo)
colSums(is.na(df_Turismo))
```
Se observa que no hay ningun NA
```{r}
#Huecos en blanco
sum(df_Turismo == "", na.rm = TRUE)
colSums(df_Turismo == "", na.rm = TRUE)
```
Tampoco se observan huecos en blanco, por lo que el dataset está limpio.

## OCUPACIÓN

```{r}
df_Ocupacion %>% glimpse()
```


# LIMPIEZA BASE DE DATOS 

##TURISMO 

Ahora voy a toquetear las fechas

```{r}
df_Turismo <- df_Turismo%>%
  separate(col=Periodo,into=c('Año', 'Mes'), sep='M')

df_Turismo <- df_Turismo %>%
  mutate(fecha = ym(paste0(Año, "-", Mes)))
```

## OCUPACIÓN

```{r}
df_Ocupacion_clean <- df_Ocupacion %>%
  dplyr::filter(Comunidades.y.Ciudades.Autónomas != "Total Nacional") %>% #elimino los totales pq son redundantes
  dplyr::filter(Sector.económico == "Servicios") %>% #filtro para quedarme solo con el sector servicios que es el que me interesa
  mutate(Comunidades.y.Ciudades.Autónomas = str_replace(Comunidades.y.Ciudades.Autónomas, "^[0-9]+\\s+", "")) %>%#elimino la enumeracion de los nombres de las comunidades
  select(-Sexo, -Sector.económico) %>% 
  mutate(Periodo = as.yearqtr(str_replace(Periodo, "T", "-"))) %>%
  rename('Comunidades Autónomas'= Comunidades.y.Ciudades.Autónomas)

```

Para tener una imagen general de como se mueve la ocupación
```{r}

```

